<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reyes Magos: Apertura Libre üëë</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --royal: #1a237e; --gold: #c5a059; --bg: #f8f9fa; --white: #ffffff; --text: #2c3e50; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: var(--white); border-radius: 15px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 4px solid var(--gold); }
        h1, h2, h3 { color: var(--royal); text-align: center; }
        
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
        button { background: var(--royal); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
        button:disabled { background: #bdc3c7; opacity: 0.7; }
        .btn-outline { background: white; border: 2px solid var(--gold); color: var(--gold); }

        /* ASIGNACI√ìN */
        .flex-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .flex-grid { grid-template-columns: 1fr; } }
        .list-item { background: #fff; border: 1px solid #eee; padding: 12px; margin-bottom: 8px; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .list-item.selected { background: var(--gold); color: white; border-color: var(--gold); }
        .count-badge { background: var(--royal); color: white; padding: 2px 8px; border-radius: 20px; font-size: 12px; float: right; }

        /* JUEGO LIBRE */
        .my-section { background: #eef2ff; padding: 15px; border-radius: 15px; border: 2px solid var(--royal); margin-bottom: 30px; }
        .others-section { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .gift-box { background: white; border-radius: 10px; padding: 10px; text-align: center; border: 1px solid #ddd; cursor: pointer; position: relative; }
        .gift-box.opened { border-color: var(--gold); }
        .gift-img { width: 100%; height: 80px; object-fit: cover; border-radius: 4px; margin-top: 5px; }
        .label-user { font-size: 11px; font-weight: bold; color: var(--royal); display: block; margin-bottom: 5px; }
    </style>
</head>
<body>

<div id="app" class="container">
    <div v-if="step === 'identity'" class="card">
        <h1>üëë Mi Saco de Regalos</h1>
        <input v-model="user.name" placeholder="Escribe tu nombre">
        <div style="margin-top: 20px;">
            <div v-for="(rg, idx) in user.myGifts" :key="idx" style="background:#fafafa; padding:10px; margin-bottom:10px; border-radius:8px;">
                <input v-model="rg.realName" placeholder="Regalo real">
                <input v-model="rg.fakeDesc" placeholder="Pista o descripci√≥n">
                <input v-model="rg.imgUrl" placeholder="URL Foto (opcional)">
            </div>
            <button class="btn-outline" @click="addGiftSlot">+ A√±adir otro</button>
            <button @click="step = 'rooms'" :disabled="!user.name || user.myGifts.some(g => !g.realName)">Siguiente: Salas</button>
        </div>
    </div>

    <div v-if="step === 'rooms'" class="card">
        <h2>üìç Elige Castillo</h2>
        <div v-if="availableRooms.length === 0">
            <button @click="createNewRoom">Crear nueva Sala</button>
        </div>
        <div v-else>
            <div v-for="room in availableRooms" :key="room.id" class="list-item" @click="joinRoom(room.id)">
                <strong>Sala: {{ room.id }}</strong> ({{ room.playerCount }} p.)
            </div>
            <button class="btn-outline" @click="createNewRoom">Nueva Sala</button>
        </div>
    </div>

    <div v-if="step === 'assign'" class="card">
        <h2>üéÅ Repartiendo Ilusi√≥n</h2>
        <p style="text-align:center; font-size:13px">Selecciona un regalo y luego a qui√©n d√°rselo.</p>
        <div class="flex-grid">
            <div>
                <h4>Mis Regalos</h4>
                <div v-for="g in user.myGifts" :key="g.id" class="list-item" :class="{selected: selectedGiftId === g.id}" @click="selectedGiftId = g.id">
                    {{ g.realName }}
                </div>
            </div>
            <div>
                <h4>Destinatarios</h4>
                <div v-for="p in participants" :key="p.name" class="list-item" @click="assignTo(p.name)">
                    <strong>{{ p.name }}</strong>
                    <span class="count-badge">üéÅ {{ p.assignedGifts ? p.assignedGifts.length : 0 }}</span>
                </div>
            </div>
        </div>
        <button @click="markAsReady" :disabled="user.myGifts.length > 0">LISTO: EMPEZAR JUEGO</button>
    </div>

    <div v-if="step === 'waiting'" class="card" style="text-align:center">
        <h2>‚åõ Preparando el Gran D√≠a</h2>
        <div v-for="p in participants" :key="p.name" style="padding:8px">{{ p.name }}: {{ p.ready ? '‚úÖ LISTO' : 'üïØÔ∏è ASIGNANDO...' }}</div>
    </div>

    <div v-if="step === 'game'">
        <div class="my-section">
            <h3>üéÅ TUS REGALOS RECIBIDOS</h3>
            <div class="others-section">
                <div v-for="(gift, idx) in myReceivedGifts" :key="idx" class="gift-box" @click="openMyGift(idx)">
                    <div v-if="!gift.opened">
                        <div style="font-size:30px">üì¶</div>
                        <div style="font-size:11px">{{ gift.fakeDesc }}</div>
                    </div>
                    <div v-else>
                        <img :src="gift.imgUrl || 'https://via.placeholder.com/80?text=Regalo'" class="gift-img">
                        <div style="font-size:12px; font-weight:bold">{{ gift.realName }}</div>
                    </div>
                </div>
            </div>
        </div>

        <h3>üåç REGALOS DE LA CORTE</h3>
        <div class="others-section">
            <template v-for="p in participants">
                <div v-for="g in p.assignedGifts" v-if="p.name !== user.name" class="gift-box" style="cursor:default">
                    <span class="label-user">{{ p.name }}</span>
                    <div v-if="!g.opened">üì¶ <small>?</small></div>
                    <div v-else>
                        <img :src="g.imgUrl || 'https://via.placeholder.com/80?text=Regalo'" class="gift-img">
                        <div style="font-size:10px">{{ g.realName }}</div>
                    </div>
                </div>
            </template>
        </div>
    </div>
</div>

<script>
const { createApp, ref, onMounted, computed } = Vue;

const firebaseConfig = {
    apiKey: "AIzaSyDiyIfptSOxDeTmUK48SJ6HIDTjs3sI7zs",
    authDomain: "juegoenvidioso.firebaseapp.com",
    databaseURL: "https://juegoenvidioso-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "juegoenvidioso",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

createApp({
    setup() {
        const step = ref('identity'), roomId = ref(''), user = ref({ name: '', myGifts: [{ id: Date.now(), realName: '', fakeDesc: '', imgUrl: '' }] });
        const availableRooms = ref([]), participants = ref([]), selectedGiftId = ref(null);

        const myReceivedGifts = computed(() => {
            const me = participants.value.find(p => p.name === user.value.name);
            return me ? me.assignedGifts || [] : [];
        });

        onMounted(() => {
            db.ref('rooms').on('value', snap => {
                const data = snap.val();
                availableRooms.value = data ? Object.keys(data).map(k => ({ id: k, playerCount: Object.keys(data[k].participants || {}).length })) : [];
            });
        });

        const addGiftSlot = () => user.value.myGifts.push({ id: Date.now()+Math.random(), realName: '', fakeDesc: '', imgUrl: '' });
        const createNewRoom = () => joinRoom(Math.random().toString(36).substring(2, 6).toUpperCase());

        const joinRoom = (id) => {
            roomId.value = id;
            const key = user.value.name.replace(/[\.\#\$\/\[\]]/g, "_");
            db.ref(`rooms/${id}/participants/${key}`).set({ name: user.value.name, ready: false, assignedGifts: [] });
            db.ref(`rooms/${id}/participants`).on('value', snap => {
                if (snap.val()) {
                    participants.value = Object.values(snap.val());
                    if (participants.value.every(p => p.ready) && participants.value.length > 1) step.value = 'game';
                }
            });
            step.value = 'assign';
        };

        const assignTo = (targetName) => {
            if (!selectedGiftId.value) return;
            const idx = user.value.myGifts.findIndex(g => g.id === selectedGiftId.value);
            const gift = { ...user.value.myGifts.splice(idx, 1)[0], from: user.value.name, opened: false };
            const key = targetName.replace(/[\.\#\$\/\[\]]/g, "_");
            db.ref(`rooms/${roomId.value}/participants/${key}/assignedGifts`).once('value', s => {
                const cur = s.val() || [];
                cur.push(gift);
                db.ref(`rooms/${roomId.value}/participants/${key}/assignedGifts`).set(cur);
            });
            selectedGiftId.value = null;
        };

        const markAsReady = () => {
            db.ref(`rooms/${roomId.value}/participants/${user.value.name.replace(/[\.\#\$\/\[\]]/g, "_")}`).update({ ready: true });
            step.value = 'waiting';
        };

        const openMyGift = (giftIdx) => {
            const key = user.value.name.replace(/[\.\#\$\/\[\]]/g, "_");
            db.ref(`rooms/${roomId.value}/participants/${key}/assignedGifts/${giftIdx}`).update({ opened: true });
        };

        return { step, user, availableRooms, participants, selectedGiftId, myReceivedGifts, addGiftSlot, createNewRoom, joinRoom, assignTo, markAsReady, openMyGift };
    }
}).mount('#app');
</script>
</body>
</html>