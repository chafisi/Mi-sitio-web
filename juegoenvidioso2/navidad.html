<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reyes Magos: El Gran Reparto üëë</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/4.1.0/vuedraggable.umd.min.js"></script>

    <style>
        :root { --gold: #d4af37; --royal: #002366; --velvet: #800020; --cream: #fdfcf0; --night: #0a0e1a; }
        body { font-family: 'Georgia', serif; background: var(--night); color: white; margin: 0; padding: 15px; background-image: radial-gradient(circle at center, #1a2a4a 0%, #0a0e1a 100%); min-height: 100vh; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* ESTILOS COMUNES */
        .card { background: rgba(255, 255, 255, 0.05); border: 2px solid var(--gold); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); backdrop-filter: blur(10px); }
        h1, h2, h3 { color: var(--gold); text-align: center; font-variant: small-caps; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid var(--gold); background: rgba(255,255,255,0.9); color: #333; box-sizing: border-box; }
        button { background: linear-gradient(135deg, var(--gold), #b8860b); color: var(--royal); border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; font-size: 1.1em; transition: 0.3s; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212, 175, 55, 0.5); }
        button:disabled { background: #555; cursor: not-allowed; transform: none; }

        /* DRAG & DROP */
        .drop-zone { min-height: 60px; background: rgba(212, 175, 55, 0.1); border: 2px dashed var(--gold); border-radius: 15px; padding: 10px; margin-top: 10px; }
        .draggable-item { background: var(--cream); color: #333; padding: 12px; margin: 8px 0; border-radius: 8px; font-weight: bold; cursor: grab; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--velvet); }
        .person-box { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px; border: 1px solid rgba(212, 175, 55, 0.3); margin-bottom: 15px; }

        /* FASE APERTURA: REYES MAGOS STYLE */
        .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-top: 30px; }
        .gift-box-reyes { background: var(--cream); border-radius: 15px; overflow: hidden; position: relative; min-height: 220px; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; color: #333; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; text-align: center; border: 4px solid var(--gold); }
        .gift-box-reyes.opened { background: white; transform: rotate(0); }
        .gift-box-reyes img { width: 100%; height: 120px; object-fit: cover; border-radius: 10px; margin-bottom: 10px; }
        .owner-tag { position: absolute; top: 0; left: 0; right: 0; background: var(--velvet); color: white; padding: 5px; font-size: 0.7em; font-weight: bold; }
        .fake-desc { font-style: italic; font-size: 0.9em; color: #666; }
        .turn-indicator { background: var(--velvet); padding: 15px; border-radius: 15px; text-align: center; border: 2px solid var(--gold); margin-bottom: 25px; }

        .flex-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        @media (max-width: 600px) { .flex-cols { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div id="app" class="container">
    <div v-if="step === 'identity'" class="card">
        <h1>üëë Perfil del Rey Mago</h1>
        <input v-model="user.name" placeholder="Tu Nombre">
        <div style="margin-top: 20px;">
            <h3>Tus Regalos para el saco</h3>
            <div v-for="(rg, idx) in user.myGifts" :key="idx" style="margin-bottom: 15px; background: rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; border: 1px solid var(--gold);">
                <input v-model="rg.realName" placeholder="Contenido Real (Ej: Reloj)">
                <input v-model="rg.fakeDesc" placeholder="Pista de Reyes (Ej: Algo que da vueltas...)">
                <input v-model="rg.imgUrl" placeholder="URL Foto del regalo (Opcional)">
            </div>
            <button @click="addGiftSlot" style="background: transparent; color: var(--gold); border: 1px solid var(--gold); margin-bottom: 10px;">+ A√±adir Regalo</button>
            <button @click="step = 'rooms'" :disabled="!user.name || user.myGifts.some(g => !g.realName)">Ver Salas</button>
        </div>
    </div>

    <div v-if="step === 'rooms'" class="card">
        <h2>üè∞ Selecciona un Castillo</h2>
        <div v-if="availableRooms.length === 0">
            <p style="text-align: center">No hay castillos disponibles ahora mismo.</p>
            <button @click="createNewRoom">Fundar Nuevo Castillo (Sala)</button>
        </div>
        <div v-else>
            <div v-for="room in availableRooms" :key="room.id" class="card" style="margin-bottom:10px; cursor:pointer; background: var(--velvet);" @click="joinRoom(room.id)">
                <h3 style="margin:0; color:white">Castillo: {{ room.id }}</h3>
                <p style="margin:5px 0 0 0; font-size:0.8em">Corte: {{ room.playerCount }} participantes</p>
            </div>
            <button @click="createNewRoom" style="margin-top:15px; background: var(--royal); color: white;">Crear nueva sala</button>
        </div>
    </div>

    <div v-if="step === 'assign'" class="card">
        <h2>üìú El Reparto de los Reyes</h2>
        <p style="text-align:center">Asigna cada regalo a su destinatario arrastr√°ndolo.</p>
        
        <div class="flex-cols">
            <div>
                <h4>üéÅ Saco de Regalos</h4>
                <draggable class="drop-zone" :list="user.myGifts" group="reyes" item-key="id">
                    <template #item="{element}">
                        <div class="draggable-item">{{ element.realName }}</div>
                    </template>
                </draggable>
            </div>
            <div>
                <h4>üë• La Corte</h4>
                <div v-for="p in participants" :key="p.name" class="person-box">
                    <strong>{{ p.name }}</strong>
                    <draggable class="drop-zone" :list="p.assignedGifts" group="reyes" item-key="id" @change="syncAssignment">
                        <template #item="{element}">
                            <div class="draggable-item" style="background: #fff4d1; border-left-color: var(--gold);">{{ element.realName }}</div>
                        </template>
                    </draggable>
                </div>
            </div>
        </div>
        <button @click="markAsReady" :disabled="user.myGifts.length > 0" style="margin-top: 25px;">CONFIRMAR REPARTO</button>
    </div>

    <div v-if="step === 'waiting'" class="card" style="text-align:center">
        <h2>‚è≥ Esperando al resto de Sabios...</h2>
        <div v-for="p in participants" :key="p.name" style="margin: 10px 0; font-size: 1.2em;">
            {{ p.name }} {{ p.ready ? '‚úÖ LISTO' : 'üïØÔ∏è Preparando...' }}
        </div>
    </div>

    <div v-if="step === 'game'">
        <div class="turn-indicator">
            <h2 style="margin:0; color: white;">Es el turno de:</h2>
            <h1 style="margin:5px 0; color: var(--gold); font-size: 2.5em;">{{ participants[gameStatus.turnIndex]?.name }}</h1>
            <p style="margin:0; opacity: 0.8;">Ronda: {{ gameStatus.round }}</p>
        </div>

        <div class="game-grid">
            <div v-for="gift in allGifts" :key="gift.id" class="gift-box-reyes" @click="openGift(gift)">
                <div class="owner-tag">PARA: {{ gift.target }}</div>
                
                <div v-if="!gift.opened">
                    <div style="font-size: 50px;">üéÅ</div>
                    <p class="fake-desc">{{ gift.fakeDesc || 'Un misterioso regalo...' }}</p>
                    <small style="opacity:0.6">Tocar para descubrir</small>
                </div>
                
                <div v-else>
                    <img :src="gift.imgUrl || 'https://via.placeholder.com/150?text=Regalo'" alt="regalo">
                    <strong style="display:block; color:var(--velvet)">{{ gift.realName }}</strong>
                    <p style="font-size: 0.8em; margin: 5px 0;">De: {{ gift.from }}</p>
                </div>
            </div>
        </div>

        <div style="margin-top: 30px;" v-if="isMyTurn">
            <button @click="passTurn" style="background: var(--royal); color: white;">Pasar Turno</button>
        </div>
    </div>
</div>

<script>
const { createApp, ref, onMounted, computed } = Vue;

// CONFIGURACI√ìN FIREBASE (Manteniendo tu DB)
const firebaseConfig = {
    apiKey: "AIzaSyDiyIfptSOxDeTmUK48SJ6HIDTjs3sI7zs",
    authDomain: "juegoenvidioso.firebaseapp.com",
    databaseURL: "https://juegoenvidioso-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "juegoenvidioso",
    storageBucket: "juegoenvidioso.firebasestorage.app",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

createApp({
    components: { draggable: window.vuedraggable },
    setup() {
        const step = ref('identity');
        const user = ref({ name: '', myGifts: [{ id: Date.now(), realName: '', fakeDesc: '', imgUrl: '' }] });
        const roomId = ref('');
        const availableRooms = ref([]);
        const participants = ref([]);
        const gameStatus = ref({ started: false, turnIndex: 0, round: 1 });

        // COMPUTED
        const isMyTurn = computed(() => {
            const current = participants.value[gameStatus.value.turnIndex];
            return current && current.name === user.name;
        });

        const allGifts = computed(() => {
            let list = [];
            participants.value.forEach(p => {
                if(p.assignedGifts) {
                    p.assignedGifts.forEach(g => {
                        list.push({ ...g, target: p.name });
                    });
                }
            });
            return list;
        });

        onMounted(() => {
            db.ref('rooms').on('value', snap => {
                const data = snap.val();
                if (!data) return availableRooms.value = [];
                availableRooms.value = Object.keys(data).map(k => ({
                    id: k, playerCount: Object.keys(data[k].participants || {}).length
                }));
            });
        });

        const addGiftSlot = () => user.value.myGifts.push({ id: Date.now()+Math.random(), realName: '', fakeDesc: '', imgUrl: '' });

        const createNewRoom = () => joinRoom(Math.random().toString(36).substring(2, 6).toUpperCase());

        const joinRoom = (id) => {
            roomId.value = id;
            const userKey = user.value.name.replace(/[\.\#\$\/\[\]]/g, "_");
            db.ref(`rooms/${id}/participants/${userKey}`).set({
                name: user.value.name, ready: false, assignedGifts: []
            });
            initRoomListener(id);
            step.value = 'assign';
        };

        const initRoomListener = (id) => {
            db.ref(`rooms/${id}/participants`).on('value', snap => {
                const data = snap.val();
                if (data) {
                    participants.value = Object.values(data).map(p => ({ ...p, assignedGifts: p.assignedGifts || [] }));
                    if (participants.value.every(p => p.ready) && participants.value.length > 1) {
                        db.ref(`rooms/${id}/gameStatus`).update({ started: true });
                    }
                }
            });
            db.ref(`rooms/${id}/gameStatus`).on('value', snap => {
                const data = snap.val();
                if(data && data.started) {
                    gameStatus.value = data;
                    step.value = 'game';
                }
            });
        };

        const syncAssignment = () => {
            participants.value.forEach(p => {
                const userKey = p.name.replace(/[\.\#\$\/\[\]]/g, "_");
                // Inyectamos qui√©n env√≠a el regalo
                const giftsWithFrom = p.assignedGifts.map(g => ({ ...g, from: user.value.name }));
                db.ref(`rooms/${roomId.value}/participants/${userKey}/assignedGifts`).set(giftsWithFrom);
            });
        };

        const markAsReady = () => {
            const userKey = user.value.name.replace(/[\.\#\$\/\[\]]/g, "_");
            db.ref(`rooms/${roomId.value}/participants/${userKey}`).update({ ready: true });
            step.value = 'waiting';
        };

        const openGift = (gift) => {
            if(!isMyTurn.value || gift.opened) return;
            // Buscamos el regalo en la estructura de la DB para abrirlo
            participants.value.forEach(p => {
                const userKey = p.name.replace(/[\.\#\$\/\[\]]/g, "_");
                const giftIdx = p.assignedGifts.findIndex(g => g.id === gift.id);
                if(giftIdx !== -1) {
                    db.ref(`rooms/${roomId.value}/participants/${userKey}/assignedGifts/${giftIdx}`).update({ opened: true });
                }
            });
            passTurn();
        };

        const passTurn = () => {
            let nextIdx = gameStatus.value.turnIndex + 1;
            let nextRound = gameStatus.value.round;
            if (nextIdx >= participants.value.length) { nextIdx = 0; nextRound++; }
            db.ref(`rooms/${roomId.value}/gameStatus`).update({ turnIndex: nextIdx, round: nextRound });
        };

        return { step, user, availableRooms, roomId, participants, gameStatus, allGifts, isMyTurn, addGiftSlot, createNewRoom, joinRoom, syncAssignment, markAsReady, openGift, passTurn };
    }
}).mount('#app');
</script>
</body>
</html>