<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reyes Magos PRO üëë</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --royal: #1a237e; --gold: #c5a059; --bg: #f4f7f6; --white: #ffffff; --text: #2c3e50; --error: #d32f2f; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: var(--white); border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 4px solid var(--gold); }
        h1, h2, h3 { color: var(--royal); text-align: center; margin-top: 0; }
        
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
        button { background: var(--royal); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        .btn-outline { background: white; border: 2px solid var(--gold); color: var(--gold); }

        /* ASIGNACI√ìN */
        .flex-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 600px) { .flex-grid { grid-template-columns: 1fr; } }
        
        .list-item { background: #fff; border: 1px solid #ddd; padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; position: relative; }
        .list-item.selected { border-color: var(--royal); background: #e8eaf6; box-shadow: 0 0 0 2px var(--royal); }
        
        .tag-gift { display: inline-flex; align-items: center; background: #e0e0e0; color: #333; padding: 4px 10px; border-radius: 4px; font-size: 12px; margin: 2px; border: 1px solid #ccc; }
        .tag-gift.mine { background: var(--royal); color: white; }
        .remove-btn { margin-left: 8px; cursor: pointer; font-weight: bold; color: #ffab91; }
        .badge-count { background: #666; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; float: right; }

        /* JUEGO */
        .game-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .gift-box { background: white; border-radius: 10px; padding: 15px; text-align: center; border: 1px solid #ddd; cursor: pointer; }
        .gift-box.opened { background: #f0f4c3; border-color: var(--gold); }

        /* MODAL */
        .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; max-width: 400px; width: 100%; text-align: center; border: 5px solid var(--gold); }
        .modal-content h2 { margin-bottom: 10px; font-size: 24px; }
        .modal-content p { font-style: italic; color: #555; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="app" class="container">
    <div v-if="step === 'identity'" class="card">
        <h1>üëë Registro Real</h1>
        <input v-model="user.name" placeholder="Tu nombre">
        <div style="margin-top: 20px;">
            <h3>Regalos para el Saco</h3>
            <div v-for="(rg, idx) in user.myGifts" :key="idx" class="card" style="border:1px solid #eee; background:#fafafa">
                <input v-model="rg.realName" placeholder="Nombre del regalo">
                <input v-model="rg.fakeDesc" placeholder="Descripci√≥n (pista)">
            </div>
            <button class="btn-outline" @click="addGiftSlot">+ A√±adir otro</button>
            <button @click="step = 'rooms'" :disabled="!user.name || user.myGifts.some(g => !g.realName)">Siguiente: Salas</button>
        </div>
    </div>

    <div v-if="step === 'rooms'" class="card">
        <h2>üè∞ Selecci√≥n de Castillo</h2>
        <div v-if="availableRooms.length === 0">
            <button @click="createNewRoom">Crear nueva Sala</button>
        </div>
        <div v-else>
            <div v-for="room in availableRooms" :key="room.id" class="list-item" @click="joinRoom(room.id)">
                <strong>Sala: {{ room.id }}</strong> ({{ room.playerCount }} participantes)
            </div>
            <button class="btn-outline" @click="createNewRoom">Nueva Sala</button>
        </div>
    </div>

    <div v-if="step === 'assign'" class="card">
        <h2>üéÅ Reparto de Regalos</h2>
        <div class="flex-grid">
            <div>
                <h4>Mis Regalos sueltos</h4>
                <div v-for="g in user.myGifts" :key="g.id" 
                     class="list-item" :class="{selected: selectedGiftId === g.id}"
                     @click="selectedGiftId = g.id">
                    {{ g.realName }}
                </div>
            </div>
            <div>
                <h4>Participantes</h4>
                <div v-for="p in participants" :key="p.name" class="list-item" @click="assignTo(p.name)">
                    <strong>{{ p.name }}</strong>
                    <div style="margin-top:5px">
                        <template v-for="(g, gIdx) in p.assignedGifts">
                            <span v-if="g.from === user.name" class="tag-gift mine">
                                {{ g.realName }} <span class="remove-btn" @click.stop="undoAssign(p.name, gIdx)">‚úï</span>
                            </span>
                            <span v-else class="tag-gift">üéÅ</span>
                        </template>
                    </div>
                </div>
            </div>
        </div>
        <button @click="markAsReady" :disabled="user.myGifts.length > 0" style="margin-top:20px">LISTO: EMPEZAR</button>
    </div>

    <div v-if="step === 'waiting'" class="card" style="text-align:center">
        <h2>‚è≥ Esperando al resto...</h2>
        <div v-for="p in participants" :key="p.name" style="padding:10px; border-bottom:1px solid #eee">
            {{ p.name }}: <strong>{{ p.ready ? '‚úÖ LISTO' : 'üïØÔ∏è ASIGNANDO...' }}</strong>
        </div>
    </div>

    <div v-if="step === 'game'">
        <div class="card" style="background:var(--royal); color:white; border:none; text-align:center">
            <h2 style="color:white; margin:0">üéÅ Gran Apertura</h2>
            <p style="margin:5px 0 0 0; opacity:0.8">Toca tus regalos para abrirlos</p>
        </div>

        <div v-for="p in participants" :key="p.name" class="card">
            <h3>{{ p.name === user.name ? '‚ú® MIS REGALOS' : p.name }}</h3>
            <div class="game-grid">
                <div v-for="(g, idx) in p.assignedGifts" :key="idx" 
                     class="gift-box" :class="{opened: g.opened}"
                     @click="handleBoxClick(p.name, g, idx)">
                    <div v-if="!g.opened">üéÅ</div>
                    <div v-else>
                        <div style="font-weight:bold; font-size:12px">{{ g.realName }}</div>
                        <div style="font-size:10px; color:#666">De: {{ g.from }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="openedGiftDetail" class="modal-overlay" @click="openedGiftDetail = null">
        <div class="modal-content" @click.stop>
            <div style="font-size: 50px; margin-bottom: 15px;">üéâ</div>
            <h2>{{ openedGiftDetail.realName }}</h2>
            <p>"{{ openedGiftDetail.fakeDesc }}"</p>
            <div style="border-top: 1px solid #eee; padding-top: 15px; font-size: 14px;">
                Regalado por: <strong>{{ openedGiftDetail.from }}</strong>
            </div>
            <button @click="openedGiftDetail = null" style="margin-top: 20px;">Cerrar</button>
        </div>
    </div>
</div>

<script>
const { createApp, ref, onMounted } = Vue;

const firebaseConfig = {
    apiKey: "AIzaSyDiyIfptSOxDeTmUK48SJ6HIDTjs3sI7zs",
    authDomain: "juegoenvidioso.firebaseapp.com",
    databaseURL: "https://juegoenvidioso-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "juegoenvidioso",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

createApp({
    setup() {
        const step = ref('identity');
        const user = ref({ name: '', myGifts: [{ id: Date.now(), realName: '', fakeDesc: '' }] });
        const roomId = ref('');
        const availableRooms = ref([]);
        const participants = ref([]);
        const selectedGiftId = ref(null);
        const openedGiftDetail = ref(null);

        onMounted(() => {
            db.ref('rooms').on('value', snap => {
                const data = snap.val();
                availableRooms.value = data ? Object.keys(data).map(k => ({ id: k, playerCount: Object.keys(data[k].participants || {}).length })) : [];
            });
        });

        const addGiftSlot = () => user.value.myGifts.push({ id: Date.now()+Math.random(), realName: '', fakeDesc: '' });
        
        const createNewRoom = () => joinRoom(Math.random().toString(36).substring(2, 6).toUpperCase());

        const joinRoom = (id) => {
            roomId.value = id;
            const key = user.value.name.replace(/[\.\#\$\/\[\]]/g, "_");
            db.ref(`rooms/${id}/participants/${key}`).set({ name: user.value.name, ready: false, assignedGifts: [] });
            
            db.ref(`rooms/${id}/participants`).on('value', snap => {
                if (snap.val()) {
                    participants.value = Object.values(snap.val());
                    if (participants.value.every(p => p.ready) && participants.value.length > 1) step.value = 'game';
                }
            });
            step.value = 'assign';
        };

        const assignTo = (targetName) => {
            if (!selectedGiftId.value) return;
            const idx = user.value.myGifts.findIndex(g => g.id === selectedGiftId.value);
            const gift = { ...user.value.myGifts.splice(idx, 1)[0], from: user.value.name, opened: false };
            
            const targetKey = targetName.replace(/[\.\#\$\/\[\]]/g, "_");
            db.ref(`rooms/${roomId.value}/participants/${targetKey}/assignedGifts`).once('value', s => {
                const cur = s.val() || [];
                cur.push(gift);
                db.ref(`rooms/${roomId.value}/participants/${targetKey}/assignedGifts`).set(cur);
            });
            selectedGiftId.value = null;
        };

        const undoAssign = (targetName, giftIdx) => {
            const targetKey = targetName.replace(/[\.\#\$\/\[\]]/g, "_");
            db.ref(`rooms/${roomId.value}/participants/${targetKey}/assignedGifts`).once('value', s => {
                let gifts = s.val() || [];
                const removed = gifts.splice(giftIdx, 1)[0];
                db.ref(`rooms/${roomId.value}/participants/${targetKey}/assignedGifts`).set(gifts);
                // Devolver a mi lista local (sin propiedades de juego)
                user.value.myGifts.push({ id: removed.id, realName: removed.realName, fakeDesc: removed.fakeDesc });
            });
        };

        const markAsReady = () => {
            db.ref(`rooms/${roomId.value}/participants/${user.value.name.replace(/[\.\#\$\/\[\]]/g, "_")}`).update({ ready: true });
            step.value = 'waiting';
        };

        const handleBoxClick = (ownerName, gift, idx) => {
            if (ownerName !== user.value.name && !gift.opened) return; // Solo puedo abrir los m√≠os
            
            if (!gift.opened) {
                const key = ownerName.replace(/[\.\#\$\/\[\]]/g, "_");
                db.ref(`rooms/${roomId.value}/participants/${key}/assignedGifts/${idx}`).update({ opened: true });
            }
            // Mostrar modal con los detalles
            openedGiftDetail.value = gift;
        };

        return { step, user, availableRooms, roomId, participants, selectedGiftId, openedGiftDetail, addGiftSlot, createNewRoom, joinRoom, assignTo, undoAssign, markAsReady, handleBoxClick };
    }
}).mount('#app');
</script>
</body>
</html>