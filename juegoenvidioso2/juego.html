<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regalo Envidioso PRO üéÅ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #ff4757; --secondary: #2f3542; --success: #2ed573; --bg: #f1f2f6; --white: #ffffff; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); margin: 0; display: flex; justify-content: center; color: var(--secondary); }
        #app { width: 100%; max-width: 500px; padding: 15px; box-sizing: border-box; }
        .card-panel { background: var(--white); padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-top: 20px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #eee; border-radius: 12px; box-sizing: border-box; }
        .game-header { background: var(--secondary); color: white; padding: 15px; border-radius: 20px; margin-bottom: 20px; position: relative; text-align: center; }
        .stats-badge { position: absolute; top: 15px; right: 15px; text-align: right; font-size: 11px; line-height: 1.3; }
        .timer-badge { background: #ffa502; padding: 5px 12px; border-radius: 8px; font-weight: bold; display: inline-block; margin-top: 5px; color: var(--secondary); }
        .order-badge { background: var(--primary); color: white; padding: 10px; border-radius: 15px; font-size: 18px; font-weight: bold; margin-bottom: 15px; text-align: center; border: 2px solid white; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .gift-card { background: var(--white); border-radius: 20px; padding: 15px; text-align: center; border: 3px solid transparent; position: relative; transition: all 0.3s; }
        .is-mine { border-color: var(--primary) !important; background: #fff5f5; }
        .is-active-turn { border: 3px dashed #70a1ff; }
        .owner-tag { font-size: 10px; background: var(--secondary); color: white; padding: 3px 8px; border-radius: 10px; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); z-index: 10; }
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 8px; font-size: 12px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .user-list { background: #f8f9fa; border-radius: 15px; padding: 10px; margin-top: 10px; font-size: 13px; text-align: left; }
        .user-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
        .user-row.active { color: var(--primary); font-weight: bold; }
        .btn-host-action { background: #747d8c; margin-top: 15px; border: 1px solid rgba(255,255,255,0.2); }
    </style>
</head>
<body>

<div id="app">
    <div v-if="screen === 'setup'">
        <h1 style="text-align: center;">üéÅ Regalo Envidioso</h1>
        <div class="card-panel" v-if="availableRooms.length > 0 && !isCreating">
            <h3>Salas abiertas:</h3>
            <button v-for="room in availableRooms" @click="selectRoom(room)" style="background:#70a1ff; margin-bottom: 8px;">Unirse a: {{ room }}</button>
            <button @click="isCreating = true" style="background:var(--secondary)">+ Crear nueva sala</button>
        </div>
        <div class="card-panel">
            <input v-model="userName" placeholder="* Tu nombre">
            <input v-model="giftContent" placeholder="* Nombre real del regalo">
            <input v-model="giftFakeDesc" placeholder="* Descripci√≥n trampa">
            <div v-if="!joining">
                <label>N¬∫ Participantes:</label><input type="number" v-model="numPlayers">
                <label>N¬∫ Rondas de Robo:</label><input type="number" v-model="maxRounds">
                <label>Tiempo turno (seg):</label><input type="number" v-model="maxTime">
                <button @click="createRoom" :disabled="!isFormValid">Crear Sala</button>
                <button @click="joining = true" style="background:#747d8c">C√≥digo manual</button>
            </div>
            <div v-else>
                <input v-model="roomCodeInput" placeholder="C√ìDIGO">
                <button @click="joinRoom" :disabled="!isFormValid || !roomCodeInput">Entrar</button>
                <button @click="joining = false" style="background:#747d8c">Volver</button>
            </div>
        </div>
    </div>

    <div v-if="screen === 'lobby'" class="card-panel" style="text-align: center;">
        <h2>Sala: {{ roomId }}</h2>
        <p>Participantes: {{ participants.length }} / {{ targetPlayers }}</p>
        <div class="user-list">
            <div v-for="p in participants" class="user-row">üë§ {{ p.name }}</div>
        </div>
        <button v-if="isHost" @click="startGame" style="margin-top:20px; background:var(--success)">¬°SORTEAR Y EMPEZAR!</button>
        <p v-else style="margin-top:20px; font-style: italic;">Esperando a que el anfitri√≥n inicie...</p>
    </div>

    <div v-if="screen === 'game'">
        <div class="order-badge" v-if="!gameEnded">
            POSICI√ìN DE SORTEO: {{ myOrderPosition }}
        </div>

        <div class="game-header">
            <div class="stats-badge" v-if="!gameEnded">
                {{ round === 1 ? 'APERTURA' : 'ROBO ' + (round - 1) }}<br>
                TURNO: {{ currentTurnIndex + 1 }} / {{ participants.length }}
            </div>
            <div v-if="!gameEnded">Turno de:<br><strong>{{ currentTurnPlayer }}</strong></div>
            <div v-else>üèÅ RESULTADOS FINALES</div>
            <div v-if="timeLeft > 0 && !gameEnded" class="timer-badge">‚è≥ {{ timeLeft }}s</div>
        </div>

        <div v-if="!gameEnded" class="card-panel" style="padding: 15px; margin-bottom: 10px;">
            <div class="user-list">
                <div v-for="(p, idx) in participants" :key="idx" class="user-row" :class="{ active: currentTurnIndex === idx }">
                    <span>{{ idx + 1 }}. {{ p.name }}</span>
                    <span>{{ currentTurnIndex === idx ? '‚ö°' : '' }}</span>
                </div>
            </div>
            <button v-if="isHost" @click="restartGame" class="btn-host-action">üîÑ RE-SORTEAR Y REINICIAR</button>
        </div>

        <div v-if="gameEnded" class="card-panel">
            <div v-for="gift in gifts" :key="gift.id" style="margin-bottom:8px">
                üë§ <strong>{{ gift.owner }}</strong>: üéÅ {{ gift.content }}
            </div>
            <button v-if="isHost" @click="restartGame" style="background:var(--success); margin-top:20px">üîÑ NUEVO SORTEO Y REINICIO</button>
        </div>

        <div v-else class="grid">
            <div v-for="gift in gifts" :key="gift.id" class="gift-card" :class="{ 'is-mine': gift.owner === userName, 'is-active-turn': isMyTurn }">
                <span v-if="gift.owner" class="owner-tag">üë§ {{ gift.owner }}</span>
                <span style="font-size: 40px; display: block; margin: 10px 0;">{{ gift.opened ? 'üì¶' : 'üéÅ' }}</span>
                <div style="font-weight: bold; font-size: 13px;">{{ gift.opened ? gift.content : gift.fakeDesc }}</div>
                <div v-if="isMyTurn">
                    <button v-if="!gift.opened && (round > 1 || gift.creator !== userName)" @click="openAndKeep(gift)">Abrir</button>
                    <button v-if="gift.opened && gift.owner !== userName && canISteal && round > 1" @click="stealGift(gift)">¬°ROBAR!</button>
                </div>
            </div>
        </div>
        <button v-if="isMyTurn && !gameEnded && round > 1" @click="nextTurn" style="background:#747d8c">Pasar Turno</button>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

const firebaseConfig = {
    apiKey: "AIzaSyDiyIfptSOxDeTmUK48SJ6HIDTjs3sI7zs",
    authDomain: "juegoenvidioso.firebaseapp.com",
    databaseURL: "https://juegoenvidioso-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "juegoenvidioso",
    storageBucket: "juegoenvidioso.firebasestorage.app",
    messagingSenderId: "891145514178",
    appId: "1:891145514178:web:e25b23aa564ceee96c5f5b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

createApp({
    setup() {
        const screen = ref('setup'), userName = ref(''), giftContent = ref(''), giftFakeDesc = ref(''), numPlayers = ref(2), maxTime = ref(30), maxRounds = ref(2), roomId = ref(''), roomCodeInput = ref(''), isHost = ref(false), joining = ref(false), isCreating = ref(false), availableRooms = ref([]), gameEnded = ref(false), gifts = ref([]), participants = ref([]), currentTurnIndex = ref(0), round = ref(1), targetPlayers = ref(0), timeLeft = ref(0);

        const isFormValid = computed(() => userName.value && giftContent.value && giftFakeDesc.value);
        const myOrderPosition = computed(() => participants.value.findIndex(p => p.name === userName.value) + 1 || '?');

        onMounted(() => {
            db.ref('rooms').on('value', snap => {
                const r = snap.val();
                availableRooms.value = r ? Object.keys(r).filter(k => r[k].gameStatus && !r[k].gameStatus.started && Object.keys(r[k].participants || {}).length < r[k].config.numPlayers) : [];
            });
        });

        const currentTurnPlayer = computed(() => participants.value[currentTurnIndex.value]?.name || '');
        const isMyTurn = computed(() => currentTurnPlayer.value === userName.value);
        const canISteal = computed(() => {
            const me = participants.value.find(p => p.name === userName.value);
            return me ? (me.steals || 0) < maxRounds.value : false;
        });

        const initListeners = (id) => {
            db.ref(`rooms/${id}/config`).on('value', snap => {
                const c = snap.val(); targetPlayers.value = c.numPlayers; maxRounds.value = c.maxRounds; maxTime.value = c.maxTime;
            });
            db.ref(`rooms/${id}/participants`).on('value', snap => participants.value = Object.values(snap.val() || {}));
            db.ref(`rooms/${id}/gifts`).on('value', snap => gifts.value = Object.values(snap.val() || {}));
            db.ref(`rooms/${id}/gameStatus`).on('value', snap => {
                const s = snap.val();
                if (s) {
                    currentTurnIndex.value = s.turnIndex;
                    gameEnded.value = s.ended || false;
                    round.value = s.round || 1;
                    if (s.started) screen.value = 'game';
                    if (s.deadline) startLocalTimer(s.deadline);
                }
            });
        };

        const createRoom = () => {
            const id = Math.random().toString(36).substring(2, 6).toUpperCase();
            roomId.value = id; isHost.value = true;
            db.ref(`rooms/${id}`).set({ 
                config: { numPlayers: numPlayers.value, maxTime: maxTime.value, maxRounds: maxRounds.value },
                gameStatus: { started: false, turnIndex: 0, ended: false, round: 1 }
            }).then(() => { registerInRoom(id); screen.value = 'lobby'; initListeners(id); });
        };

        const registerInRoom = (id) => {
            db.ref(`rooms/${id}/participants`).push({ name: userName.value, steals: 0 });
            db.ref(`rooms/${id}/gifts`).push({
                id: Math.random().toString(36).substr(2, 9),
                content: giftContent.value, fakeDesc: giftFakeDesc.value, creator: userName.value, opened: false, owner: ''
            });
        };

        const startGame = () => {
            const shuff = [...participants.value].sort(() => Math.random() - 0.5);
            db.ref(`rooms/${roomId.value}/participants`).set(null).then(() => {
                shuff.forEach(p => db.ref(`rooms/${roomId.value}/participants`).push({ ...p, steals: 0 }));
                syncTurn(0, 1);
            });
        };

        const syncTurn = (idx, r) => {
            const deadline = maxTime.value > 0 ? Date.now() + (maxTime.value * 1000) : null;
            db.ref(`rooms/${roomId.value}/gameStatus`).update({ started: true, turnIndex: idx, round: r, deadline: deadline, ended: false });
        };

        const openAndKeep = (gift) => {
            db.ref(`rooms/${roomId.value}/gifts`).once('value', snap => {
                const keys = snap.val();
                const key = Object.keys(keys).find(k => keys[k].id === gift.id);
                db.ref(`rooms/${roomId.value}/gifts/${key}`).update({ opened: true, owner: userName.value });
                nextTurn();
            });
        };

        const stealGift = (gift) => {
            const victim = gift.owner;
            db.ref(`rooms/${roomId.value}/gifts`).once('value', sg => {
                db.ref(`rooms/${roomId.value}/participants`).once('value', sp => {
                    const ag = sg.val(), ap = sp.val();
                    const myOldKey = Object.keys(ag).find(k => ag[k].owner === userName.value);
                    const stolenKey = Object.keys(ag).find(k => ag[k].id === gift.id);
                    const myPartKey = Object.keys(ap).find(k => ap[k].name === userName.value);
                    if (myOldKey) db.ref(`rooms/${roomId.value}/gifts/${myOldKey}`).update({ owner: victim });
                    db.ref(`rooms/${roomId.value}/gifts/${stolenKey}`).update({ owner: userName.value });
                    db.ref(`rooms/${roomId.value}/participants/${myPartKey}`).update({ steals: (ap[myPartKey].steals || 0) + 1 });
                    nextTurn();
                });
            });
        };

        const nextTurn = () => {
            let nextIdx = currentTurnIndex.value + 1;
            let nextRound = round.value;
            if (nextIdx >= participants.value.length) { nextIdx = 0; nextRound++; }
            if (nextRound > (1 + parseInt(maxRounds.value))) {
                db.ref(`rooms/${roomId.value}/gameStatus`).update({ ended: true });
            } else {
                syncTurn(nextIdx, nextRound);
            }
        };

        const restartGame = () => {
            db.ref(`rooms/${roomId.value}/gifts`).once('value', snap => {
                const gData = snap.val();
                if(gData) Object.keys(gData).forEach(k => db.ref(`rooms/${roomId.value}/gifts/${k}`).update({ opened: false, owner: '' }));
            });
            startGame();
        };

        let timer;
        const startLocalTimer = (deadline) => {
            clearInterval(timer);
            timer = setInterval(() => {
                const d = Math.round((deadline - Date.now()) / 1000);
                timeLeft.value = d > 0 ? d : 0;
                if (d <= 0) { clearInterval(timer); if (isMyTurn.value) nextTurn(); }
            }, 1000);
        };

        return { screen, userName, giftContent, giftFakeDesc, numPlayers, maxRounds, roomId, roomCodeInput, isHost, joining, isCreating, availableRooms, gameEnded, participants, gifts, currentTurnPlayer, isMyTurn, myOrderPosition, round, currentTurnIndex, isFormValid, canISteal, timeLeft, createRoom, joinRoom: () => db.ref(`rooms/${roomCodeInput.value.toUpperCase()}`).once('value', s => s.exists() ? (roomId.value = roomCodeInput.value.toUpperCase(), registerInRoom(roomId.value), screen.value = 'lobby', initListeners(roomId.value)) : alert("No existe")), selectRoom: (id) => (roomId.value = id, registerInRoom(id), screen.value = 'lobby', initListeners(id)), startGame, openAndKeep, stealGift, nextTurn, restartGame };
    }
}).mount('#app');
</script>
</body>
</html>