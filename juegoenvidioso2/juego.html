<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regalo Envidioso üéÅ</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #ff4757;
            --secondary: #2f3542;
            --success: #2ed573;
            --bg: #f1f2f6;
            --white: #ffffff;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            justify-content: center;
            color: var(--secondary);
        }

        #app {
            width: 100%;
            max-width: 500px;
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- PANTALLA SETUP --- */
        .setup-screen {
            text-align: center;
            margin-top: 30px;
            animation: fadeIn 0.5s ease;
        }

        .card-panel {
            background: var(--white);
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #eee;
            border-radius: 15px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus { border-color: var(--primary); outline: none; }

        /* --- PANTALLA JUEGO --- */
        .game-header {
            background: var(--secondary);
            color: white;
            padding: 18px;
            border-radius: 20px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .room-tag {
            background: var(--primary);
            padding: 3px 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.1em;
            margin-left: 5px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .gift-card {
            background: var(--white);
            border-radius: 20px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border: 3px solid transparent;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .gift-card.is-opened { border-color: var(--success); }
        .gift-card.is-mine { 
            border-color: var(--primary); 
            background: #fff5f5; 
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(255, 71, 87, 0.2);
        }

        .owner-tag {
            font-size: 11px;
            background: var(--secondary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .gift-icon { font-size: 45px; margin: 10px 0; display: block; }

        .package-name {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 12px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
        }

        /* --- BOTONES --- */
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            font-size: 14px;
            transition: all 0.2s;
        }

        button:active { transform: scale(0.96); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .btn-secondary { background: var(--secondary); margin-top: 12px; }
        .btn-steal { background: var(--secondary); }

        /* --- HISTORIAL --- */
        .history-log {
            margin-top: 30px;
            background: var(--white);
            padding: 20px;
            border-radius: 20px;
            max-height: 160px;
            overflow-y: auto;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
        }

        .log-entry {
            font-size: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            animation: slideIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(-15px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

<div id="app">
    <div v-if="screen === 'setup'" class="setup-screen">
        <h1>üéÅ Regalo Envidioso</h1>
        <div class="card-panel">
            <input v-model="userName" type="text" placeholder="Tu nombre">
            <input v-model="giftDesc" type="text" placeholder="Descripci√≥n de tu paquete">
            
            <div style="margin-top: 25px;">
                <button @click="createRoom" :disabled="!userName || !giftDesc">
                    Crear Nueva Sala
                </button>
                <p style="margin: 15px 0; font-size: 14px; color: #888;">‚Äî o √∫nete a una existente ‚Äî</p>
                <input v-model="roomCodeInput" type="text" placeholder="C√≥digo de Sala">
                <button class="btn-secondary" @click="joinRoom" :disabled="!userName || !giftDesc || !roomCodeInput">
                    Entrar en Sala
                </button>
            </div>
        </div>
    </div>

    <div v-if="screen === 'game'">
        <div class="game-header">
            <div>SALA: <span class="room-tag">{{ roomId }}</span></div>
            <div style="margin-top: 8px; font-size: 14px; opacity: 0.9;">
                üë§ Jugador: <strong>{{ userName }}</strong>
            </div>
        </div>

        <div class="grid">
            <div v-for="gift in gifts" :key="gift.id" 
                 class="gift-card" 
                 :class="{ 'is-opened': gift.opened, 'is-mine': gift.owner === userName }">
                
                <span v-if="gift.owner" class="owner-tag">üë§ {{ gift.owner }}</span>
                
                <span class="gift-icon">{{ gift.opened ? 'ü§°' : 'üéÅ' }}</span>
                
                <div class="package-name">
                    {{ gift.opened ? gift.content : gift.packageDesc }}
                </div>

                <button v-if="!gift.opened" @click="openGift(gift)">
                    Abrir paquete
                </button>

                <button v-if="gift.opened && gift.owner !== userName" 
                        class="btn-steal" 
                        @click="stealGift(gift)">
                    ¬°ROBAR!
                </button>
            </div>
        </div>

        <div class="history-log">
            <div style="font-weight: bold; margin-bottom: 10px; font-size: 14px;">üì¢ √öltimos movimientos:</div>
            <div v-for="(msg, index) in history" :key="index" class="log-entry">
                {{ msg }}
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref } = Vue;

    // CONFIGURACI√ìN CON TUS DATOS REALES
    const firebaseConfig = {
        apiKey: "AIzaSyDiyIfptSOxDeTmUK48SJ6HIDTjs3sI7zs",
        authDomain: "juegoenvidioso.firebaseapp.com",
        databaseURL: "https://juegoenvidioso-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "juegoenvidioso",
        storageBucket: "juegoenvidioso.firebasestorage.app",
        messagingSenderId: "891145514178",
        appId: "1:891145514178:web:e25b23aa564ceee96c5f5b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    createApp({
        setup() {
            const screen = ref('setup');
            const userName = ref('');
            const giftDesc = ref('');
            const roomId = ref('');
            const roomCodeInput = ref('');
            const gifts = ref([]);
            const history = ref([]);

            const connectToRoom = (id) => {
                roomId.value = id.toUpperCase();
                
                // 1. Registrar mi regalo en la base de datos
                const myGiftRef = db.ref(`rooms/${roomId.value}/gifts`).push();
                myGiftRef.set({
                    id: myGiftRef.key,
                    packageDesc: giftDesc.value,
                    content: 'Sorpresa...',
                    opened: false,
                    owner: '',
                    creator: userName.value
                });

                // 2. Escuchar cambios de REGALOS
                db.ref(`rooms/${roomId.value}/gifts`).on('value', (snap) => {
                    const val = snap.val();
                    gifts.value = val ? Object.values(val) : [];
                });

                // 3. Escuchar cambios de HISTORIAL
                db.ref(`rooms/${roomId.value}/history`).limitToLast(10).on('value', (snap) => {
                    const val = snap.val();
                    if (val) {
                        history.value = Object.values(val).reverse();
                    }
                });

                screen.value = 'game';
            };

            const createRoom = () => {
                const id = Math.random().toString(36).substring(2, 6).toUpperCase();
                connectToRoom(id);
            };

            const joinRoom = () => {
                connectToRoom(roomCodeInput.value);
            };

            const openGift = (gift) => {
                const content = prompt("¬øQu√© complemento de risa hay dentro?");
                if (!content) return;

                db.ref(`rooms/${roomId.value}/gifts/${gift.id}`).update({
                    opened: true,
                    content: content,
                    owner: userName.value
                });

                db.ref(`rooms/${roomId.value}/history`).push(
                    `${userName.value} abri√≥ el regalo de ${gift.creator}: ¬°${content}!`
                );
            };

            const stealGift = (gift) => {
                const oldOwner = gift.owner;

                // Liberar mis regalos anteriores
                gifts.value.forEach(g => {
                    if (g.owner === userName.value) {
                        db.ref(`rooms/${roomId.value}/gifts/${g.id}`).update({ owner: '' });
                    }
                });

                // Tomar el nuevo
                db.ref(`rooms/${roomId.value}/gifts/${gift.id}`).update({ owner: userName.value });

                db.ref(`rooms/${roomId.value}/history`).push(
                    `¬°${userName.value} le ROB√ì el/la ${gift.content} a ${oldOwner}!`
                );
            };

            return {
                screen, userName, giftDesc, roomId, roomCodeInput, gifts, history,
                createRoom, joinRoom, openGift, stealGift
            }
        }
    }).mount('#app');
</script>
</body>
</html>